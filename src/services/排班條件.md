# 排班條件說明

本文件整理 `schedulingService.js` 及相關工具（`laborCodeParser`、`prioritySorter`）中，自動排班所依據的條件與規則。

---

## 一、操作人員篩選條件（可用人員）

排班前會先從「操作人員」中篩選出**可用操作人員**，須同時滿足：

| 條件 | 說明 | 程式位置 |
|------|------|----------|
| 狀態 | 若有 `狀態` 欄位，須為「上班」；非「上班」者不列入可用人員 | `schedulingService.js` L22-25 |
| 可上班時段 | 若有 `可上班時段` 且非空陣列，須包含當前排班時段（早/中上/中下/晚）；未包含者不列入 | `schedulingService.js` L26-28 |

未通過上述篩選的人員，不會參與任何機台的人員分配。

---

## 二、機台與品號條件

| 條件 | 說明 | 結果狀態 |
|------|------|----------|
| 品號 | 機台須有「輸入品號」或「執行品號」；無品號則該機台不進行人力分配 | `無品號` |
| 人力代碼 | 人力代碼來源：先採用機台設定的「人力代碼」，若無則從品號資料的 `laborCodes` 取第一個。若品號無人力代碼資料則不分配 | `無人力代碼` |

---

## 三、人力代碼類型與人數（laborCodeParser）

人力代碼決定「需要幾人」與「是否共享多機台」，解析規則如下：

| 人力代碼 | 類型 | 人數 | 機台數 | 說明 |
|----------|------|------|--------|------|
| 手3 | manual | 3 | 1 | 3 人操作 1 機台 |
| 手2 | manual | 2 | 1 | 2 人操作 1 機台 |
| 手1 | manual | 1 | 1 | 1 人操作 1 機台 |
| 自12 | semi-auto | 2 | 3 | 2 人可操作 3 機台（共享人力） |
| 自01 | semi-auto | 1 | 1 | 1 人操作 1 機台 |
| 自（僅此一字） | auto | 0 | 1 | 全自動，不需人力 |
| 其他/未知 | unknown | 0 | 1 | 不分配人力 |

- **全自動（自）**：該機台標記為「自動」，不佔用任何人員。
- **自12**：同一人力代碼下，最多 3 台機台可共用同一組 2 人；排班時會建立「共享人力群組」。滿 3 台時依「週邊機台」判斷中間機台：**兩端機台**各由 1 人操作（第一台→人員1、第三台→人員2），**中間機台**（其週邊機台包含另外兩台）由 2 人同時操作；未滿 3 台時仍為整組 2 人分配給每台。

---

## 四、機台排班順序（優先級）

機台依**生產優先**排序後再依序排班（先排到的機台先選人）：

| 優先級（由高到低） | 說明 |
|--------------------|------|
| 方塊 | 最高 |
| 大圈 |  |
| 小圈 |  |
| 大三角 |  |
| 小三角 |  |
| 空白 | 最低 |

同優先級時，依**機台名稱**排序。  
實作：`@/utils/prioritySorter` 的 `sortByPriority`。

---

## 五、人員挑選優先順序（findBestOperators）

在「可用操作人員」中，候選人須先通過：

1. **未已被分配**：不在本輪排班已分配的 `assignedOperators` 中。
2. **無不合對象衝突**：通過 `hasConflict` 檢查（見下一節）。

通過後，依下列**優先順序**排序，再取前 `requiredCount` 人：

| 優先順序 | 條件 | 說明 |
|----------|------|------|
| 1 | 精通此品號 | 操作人員的 `對應品號` 包含當前機台品號者最優先 |
| 2 | 不精通此品號 | 不精通此品號者次之 |
| 3 | 精通其他待排品號 | 若「精通此品號」無法區分，則精通**其他待排機台品號**的人往後排，保留給其他機台 |
| 4 | 同優先級 | 以**人員名稱**排序 |

---

## 六、不合對象衝突（hasConflict）

若操作人員有填寫 **不合對象**（`operator.不合對象`，為 snkey 陣列），且機台有填寫 **週邊機台**（`machine.週邊機台`）：

- 會檢查：該人員的「不合對象」中，是否有人已被分配（在 `assignedOperators` 中）。
- 若**有**已分配的不合對象，則目前簡化邏輯視為**有衝突**，該人員不列入此機台候選人。
- 註：程式註解說明「實際應用中需要更精確的判斷」（例如是否真的被分到週邊機台）。

---

## 七、共享人力（自12）規則

- 同一人力代碼（例如自12）會建立一個**共享人力群組**，同一組 2 人最多可被分配給 3 台機台。
- **第一台機台**：為該人力代碼建立新群組，用 `findBestOperators` 找滿 2 人並標記為已分配；該台先不寫入 operators，只加入群組的待分配列表（pending）。
- **後續機台**：若同一群組尚未滿 3 台，則加入同一群組的 pending，仍不寫入 operators；滿 3 台時依「週邊機台」一次分配：
  - **中間機台**：該機台的 `週邊機台` 陣列包含另外兩台機台的 snkey → 分配 **2 人**（人員1、人員2 同時操作）。
  - **兩端機台**：依處理順序，第一台分配 **人員1**，第三台分配 **人員2**。
- 若同一群組只有 1 台或 2 台（該時段自12 機台不足 3 台），則每台都分配整組 2 人，不套用中間／兩端規則。
- 滿 3 台分配完成後關閉該群組，下一台自12 機台再開新群組並重新找人。

---

## 八、排班結果狀態

每個機台/品號會得到以下其中一種狀態：

| 狀態 | 說明 |
|------|------|
| 已排 | 已分配滿所需人數 |
| 人力不足 | 有分配人員，但人數少於所需 |
| 無可用人力 | 需要人力但找不到符合條件的可用人員 |
| 自動 | 人力代碼為「自」，不需人力 |
| 無品號 | 機台無品號 |
| 無人力代碼 | 品號無人力代碼可查 |
| 待排 | 預設狀態（若邏輯未改寫則可能不會出現在最終結果） |

---

## 九、相關檔案

| 檔案 | 用途 |
|------|------|
| `src/services/schedulingService.js` | 排班主流程、人員篩選、分配與衝突檢查 |
| `src/utils/laborCodeParser.js` | 人力代碼解析（人數、類型、機台數） |
| `src/utils/prioritySorter.js` | 機台依生產優先排序 |

---

*文件對應程式版本：以 `schedulingService.js`、`laborCodeParser.js`、`prioritySorter.js` 為準。*
